var g=["Black","White"],h="King Queen Rook Bishop Knight Pawn".split(" "),k="K Q R B N ".split(" "),aa=[0,100,50,30,30,10],m=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],n=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];function p(a,b){this.color=a;this.b=b}
var q=1,r=[!0,!0],t=[!0,!0],u=[[new p(1,2),new p(1,4),new p(1,3),new p(1,1),new p(1,0),new p(1,3),new p(1,4),new p(1,2)],[new p(1,5),new p(1,5),new p(1,5),new p(1,5),new p(1,5),new p(1,5),new p(1,5),new p(1,5)],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[new p(0,5),new p(0,5),new p(0,5),new p(0,5),new p(0,5),new p(0,5),new p(0,5),new p(0,5)],[new p(0,2),new p(0,4),new p(0,3),new p(0,1),new p(0,0),new p(0,3),new p(0,4),new p(0,2)]],w=[7,0],x=[4,4],y=[-1,-1],z=[],ba=[1,
0],A=!0,B=!0,C=!1,D;function E(a,b,c,d,e){this.b=a;this.a=d;this.g=e;this.f=b;this.c=c}function F(a){return 0===a.i?"O-O":1===a.i?"O-O-O":k[a.b]+"abcdefgh".charAt(a.g)+String(a.a+1)+(a.l?"x":"-")+"abcdefgh".charAt(a.c)+String(a.f+1)+(a.m?"ep":a.h?k[a.h]:"")}function G(a,b){a.l=b;return a}function ca(a,b){a.i=b;return a}function da(a){a.m=!0;return a}function ea(a,b){a.h=b;return a}function H(a){for(var b=[],c=0;8>c;c++)for(var d=0;8>d;d++)b=b.concat(fa(a,c,d));return ga(b,a)}
function ga(a,b){for(var c=[],d=0;d<a.length;d++)I(a[d]),J(w[b],x[b],b)||c.push(a[d]),K(a[d]);return c}
function fa(a,b,c){if(!u[b][c]||u[b][c].color!=a)return[];switch(u[b][c].b){case 5:return ha(a,b,c);case 2:return ia(a,b,c,2);case 3:return ja(a,b,c,3);case 4:for(var d=[],e=0;e<n.length;e++)ka(b+n[e][0],c+n[e][1])?d.push(new E(4,b+n[e][0],c+n[e][1],b,c)):L(b+n[e][0],c+n[e][1],a)&&d.push(G(new E(4,b+n[e][0],c+n[e][1],b,c),D));return d;case 0:d=[];for(e=0;e<m.length;e++)ka(b+m[e][0],c+m[e][1])?d.push(new E(0,b+m[e][0],c+m[e][1],b,c)):L(b+m[e][0],c+m[e][1],a)&&d.push(G(new E(0,b+m[e][0],c+m[e][1],b,
c),D));r[a]&&(u[b][5]||u[b][6]||u[b][7]&&2===u[b][7].b&&u[b][7].color===a&&(J(b,4,a)||J(b,5,a)||J(b,6,a)||d.push(ca(new E(0,b,6,b,4),0))));t[a]&&(u[b][3]||u[b][2]||u[b][1]||u[b][0]&&2===u[b][0].b&&u[b][0].color===a&&(J(b,4,a)||J(b,3,a)||J(b,2,a)||d.push(ca(new E(0,b,2,b,4),1))));return d;case 1:return ia(a,b,c,1).concat(ja(a,b,c,1))}}
function ha(a,b,c){var d,e,f,l;1===a?(d=1,e=1===b,l=4===b,f=6===b):(d=-1,e=6===b,l=3===b,f=1===b);var v=[];ka(b+d,c)&&(v.push(new E(5,b+d,c,b,c)),e&&!u[b+2*d][c]&&v.push(new E(5,b+2*d,c,b,c)));0<c&&(L(b+d,c-1,a)?v.push(G(new E(5,b+d,c-1,b,c),D)):l&&y[1-a]===c-1&&v.push(da(G(new E(5,b+d,c-1,b,c),5))));7>c&&(L(b+d,c+1,a)?v.push(G(new E(5,b+d,c+1,b,c),D)):l&&y[1-a]===c+1&&v.push(da(G(new E(5,b+d,c+1,b,c),5))));if(f&&0<v.length){var M=[];v.forEach(function(a){for(var d=1;4>=d;d++)M.push(ea(G(new E(5,
a.f,a.c,b,c),a.l),d))});return M}return v}
function ia(a,b,c,d){var e=[],f;for(f=c-1;0<=f;f--)if(u[b][f]){L(b,f,a)&&e.push(G(new E(d,b,f,b,c),D));break}else e.push(new E(d,b,f,b,c));for(f=c+1;8>f;f++)if(u[b][f]){L(b,f,a)&&e.push(G(new E(d,b,f,b,c),D));break}else e.push(new E(d,b,f,b,c));for(f=b+1;8>f;f++)if(u[f][c]){L(f,c,a)&&e.push(G(new E(d,f,c,b,c),D));break}else e.push(new E(d,f,c,b,c));for(f=b-1;0<=f;f--)if(u[f][c]){L(f,c,a)&&e.push(G(new E(d,f,c,b,c),D));break}else e.push(new E(d,f,c,b,c));return e}
function ja(a,b,c,d){var e=[],f,l;f=b+1;for(l=c+1;8>f&&8>l;){if(u[f][l]){L(f,l,a)&&e.push(G(new E(d,f,l,b,c),D));break}else e.push(new E(d,f,l,b,c));f++;l++}f=b+1;for(l=c-1;8>f&&0<=l;){if(u[f][l]){L(f,l,a)&&e.push(G(new E(d,f,l,b,c),D));break}else e.push(new E(d,f,l,b,c));f++;l--}f=b-1;for(l=c-1;0<=f&&0<=l;){if(u[f][l]){L(f,l,a)&&e.push(G(new E(d,f,l,b,c),D));break}else e.push(new E(d,f,l,b,c));f--;l--}f=b-1;for(l=c+1;0<=f&&8>l;){if(u[f][l]){L(f,l,a)&&e.push(G(new E(d,f,l,b,c),D));break}else e.push(new E(d,
f,l,b,c));f--;l++}return e}function ka(a,b){return 0>a||0>b||7<a||7<b?!1:!u[a][b]}function L(a,b,c){if(0>a||0>b||7<a||7<b||!u[a][b]||u[a][b].color===c||0===u[a][b].b)return!1;D=u[a][b].b;return!0}
function J(a,b,c){var d,e;d=a+1;for(e=b+1;8>d&&8>e;){if(u[d][e]){if(N(d,e,c)){if(3===D)return!0;if(5===D){if(d===a+1&&1===c)return!0}else if(0===D){if(d===a+1)return!0}else if(1===D)return!0}break}d++;e++}d=a+1;for(e=b-1;8>d&&0<=e;){if(u[d][e]){if(N(d,e,c)){if(3===D)return!0;if(5===D){if(d===a+1&&1===c)return!0}else if(0===D){if(d===a+1)return!0}else if(1===D)return!0}break}d++;e--}d=a-1;for(e=b-1;0<=d&&0<=e;){if(u[d][e]){if(N(d,e,c)){if(3===D)return!0;if(5===D){if(d===a-1&&0===c)return!0}else if(0===
D){if(d===a-1)return!0}else if(1===D)return!0}break}d--;e--}d=a-1;for(e=b+1;0<=d&&8>e;){if(u[d][e]){if(N(d,e,c)){if(3===D)return!0;if(5===D){if(d===a-1&&0===c)return!0}else if(0===D){if(d===a-1)return!0}else if(1===D)return!0}break}d--;e++}for(e=b-1;0<=e;e--)if(u[a][e]){if(N(a,e,c)){if(2===D)return!0;if(0===D){if(e===b-1)return!0}else if(1===D)return!0}break}for(e=b+1;8>e;e++)if(u[a][e]){if(N(a,e,c)){if(2===D)return!0;if(0===D){if(e===b+1)return!0}else if(1===D)return!0}break}for(d=a+1;8>d;d++)if(u[d][b]){if(N(d,
b,c)){if(2===D)return!0;if(0===D){if(d===a+1)return!0}else if(1===D)return!0}break}for(d=a-1;0<=d;d--)if(u[d][b]){if(N(d,b,c)){if(2===D)return!0;if(0===D){if(d===a-1)return!0}else if(1===D)return!0}break}for(d=0;d<n.length;d++)if(L(a+n[d][0],b+n[d][1],c)&&4===D)return!0;return!1}function N(a,b,c){if(u[a][b].color===c)return!1;D=u[a][b].b;return!0}
function I(a){var b=u[a.a][a.g].color;u[a.f][a.c]=u[a.a][a.g];u[a.a][a.g]=0;a.m?u[1===b?4:3][a.c]=0:0===a.i?(u[a.a][5]=u[a.a][7],u[a.a][7]=0):1===a.i?(u[a.a][3]=u[a.a][0],u[a.a][0]=0):a.h&&(u[a.f][a.c].b=a.h);a.w=y[b];y[b]=5===a.b&&(1===a.a&&3===a.f||6===a.a&&4===a.f)?a.g:-1;y[1-b]=-1;0===a.b&&(w[b]=a.f,x[b]=a.c);r[b]&&(0===a.b||2===a.b&&7===a.g)&&(r[b]=!1,a.u=!0);t[b]&&(0===a.b||2===a.b&&0===a.g)&&(t[b]=!1,a.v=!0);q=1-q;z.push(a)}
function K(a){var b=u[a.f][a.c].color;u[a.a][a.g]=u[a.f][a.c];void 0===a.l?u[a.f][a.c]=0:a.m?(u[a.f][a.c]=0,u[1===b?4:3][a.c]=new p(1-b,5)):u[a.f][a.c]=new p(1-b,a.l);a.h&&(u[a.a][a.g].b=5);0===a.b&&(0===a.i?(u[a.a][7]=u[a.a][5],u[a.a][5]=0):1===a.i&&(u[a.a][0]=u[a.a][3],u[a.a][3]=0),w[b]=a.a,x[b]=a.g);y[b]=a.w;a.u&&(r[b]=!0);a.v&&(t[b]=!0);q=1-q;z.pop()}
function la(){var a=q,b=H(a).length;if(0===b)return J(w[a],x[a],a)?-999999999:0;for(var b=b-H(1-a).length,c=0,d=0;8>d;d++)for(var e=0;8>e;e++){var f=u[d][e];f&&(c+=aa[f.b]*(f.color===a?1:-1))}return 2*b+3*c}function ma(a,b,c){if(0===a)return{o:la(),j:[]};var d=H(q);if(0===d.length)return{o:la(),j:[]};for(var e=-1E9,f=[],l=0;l<d.length;l++){I(d[l]);var v=ma(a-1,-c,-b),M=-v.o;K(d[l]);M>e&&(e=M,f=v.j.slice(),f.unshift(d[l]));b=Math.max(b,M);if(b>=c)break}return{o:e,j:f}};var na=new Audio("sound/Applause.mp3"),oa=new Audio("sound/Buzzer.mp3"),pa=new Audio("sound/tone-beep.wav"),O=document.getElementById.bind(document);O("tiles");var qa=O("highlights"),P=O("pieces"),Q=null,R=null,S="",T=null,ra=null,U="",sa=null,ta=O("a1");function V(a,b){return"abcdefgh".charAt(b)+String(a+1)}
function ua(){for(var a=0;8>a;a++)for(var b=0;8>b;b++)if(u[a][b]){var c=u[a][b],d=a,e=b,f=document.createElementNS("http://www.w3.org/2000/svg","image");f.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","img/"+h[c.b]+"_"+g[c.color]+".svg");f.setAttribute("x",12.5*e+"%");f.setAttribute("y",12.5*(7-d)+"%");f.setAttribute("width","12.5%");f.setAttribute("height","12.5%");f.setAttribute("data-color",c.color);f.setAttribute("data-row",d);f.setAttribute("data-col",e);f.setAttribute("class","piece "+
h[c.b]);f.addEventListener("click",va);P.appendChild(f);O(V(d,e)).removeEventListener("click",W)}C&&wa()}function W(a){xa(a.target)}function va(a){xa(X(a.target),a.target)}function X(a){return O(V(parseInt(a.getAttribute("data-row")),parseInt(a.getAttribute("data-col"))))}
function xa(a,b){if(1!==ba[q])if(a==Q)Y();else if(void 0!=b&&parseInt(b.getAttribute("data-color"))==q){if(Y(),Q=a,R=b,S=a.getAttribute("class"),a.setAttribute("class",S+" tile-selected"),B)for(var c=ga(fa(q,parseInt(a.getAttribute("data-row")),parseInt(a.getAttribute("data-col"))),q),d=0;d<c.length;d++){var e=document.createElementNS("http://www.w3.org/2000/svg","circle");e.setAttribute("cx",String(12.5*c[d].c+6.25)+"%");e.setAttribute("cy",String(12.5*(7-c[d].f)+6.25)+"%");c[d].l?(e.setAttribute("r",
"4%"),e.setAttribute("class","legal red")):(e.setAttribute("r","2%"),e.setAttribute("class","legal green"));qa.appendChild(e)}}else if(null!=Q){T=a;ra=b;U=a.getAttribute("class");a.setAttribute("class",U+" tile2-selected");if(R.getAttribute("class")=="piece "+h[5]){if("0"==a.getAttribute("data-row")){ya(0);return}if("7"==a.getAttribute("data-row")){ya(1);return}}(c=za())?Aa(c):Y()}}
function Y(){for(var a=Ba(qa,"legal");0<a.length;)qa.removeChild(a.item(0));Q&&(Q.setAttribute("class",S),R=Q=null,S="",T&&(T.setAttribute("class",U),ra=T=null,U="",sa=null))}
function za(){var a;a:{var b=parseInt(Q.getAttribute("data-row")),c=parseInt(Q.getAttribute("data-col"));a=parseInt(T.getAttribute("data-row"));for(var d=parseInt(T.getAttribute("data-col")),e=sa,b=ga(fa(q,b,c),q),c=0;c<b.length;c++)if(b[c].f===a&&b[c].c===d&&b[c].h==e){a=b[c];break a}a=void 0}A&&(a?na.play():oa.play());return a}
function Aa(a){ra&&P.removeChild(ra);R.setAttribute("x",12.5*a.c+"%");R.setAttribute("y",12.5*(7-a.f)+"%");R.setAttribute("data-row",a.f);R.setAttribute("data-col",a.c);var b,c;C&&(b=R.width.s.value,c=R.height.s.value,R.setAttribute("transform","translate("+(2*a.c+1)*b+" "+(2*(7-a.f)+1)*c+") rotate(180)"));if(a.m)b=Ca(5,1==q?4:3,a.c),X(b).addEventListener("click",W),P.removeChild(b);else if(0==a.i){var d=Ca(2,a.a,7);X(d).addEventListener("click",W);d.setAttribute("x","62.5%");d.setAttribute("data-col",
5);X(d).removeEventListener("click",W);C&&d.setAttribute("transform","translate("+11*b+" "+(2*(7-a.a)+1)*c+") rotate(180)")}else 1==a.i?(d=Ca(2,a.a,0),X(d).addEventListener("click",W),d.setAttribute("x","37.5%"),d.setAttribute("data-col",3),X(d).removeEventListener("click",W),C&&d.setAttribute("transform","translate("+7*b+" "+(2*(7-a.a)+1)*c+") rotate(180)")):a.h&&(R.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","img/"+h[a.h]+"_"+g[q]+".svg"),R.setAttribute("class","piece "+h[a.h]));
I(a);Da();Q.addEventListener("click",W);T.removeEventListener("click",W);Y();1===ba[q]&&(O("thinking").innerHTML="Let me think about it !",O("thinking").style.visibility="visible",setTimeout(Ea,100))}
function Ea(){var a;a=ma(3,-1E9,1E9);a=a.j.length?a.j[0]:void 0;a?(I(a),Fa(),Da(),A&&pa.play(),Q=O(V(a.a,a.g)),T=O(V(a.f,a.c)),S=Q.getAttribute("class"),U=T.getAttribute("class"),Q.setAttribute("class",S+" tile-selected"),T.setAttribute("class",U+" tile2-selected"),O("thinking").innerHTML=F(a),setTimeout(Y,800),0===H(q).length&&(O("thinking").style.visibility="hidden",Z("lose",!0))):(O("thinking").style.visibility="hidden",Z("win",!0))}
function Ca(a,b,c){a=Ba(P,h[a]);for(var d=0;d<a.length;d++)if(a.item(d).getAttribute("data-col")==c&&a.item(d).getAttribute("data-row")==b)return a.item(d)}function Ba(a,b){return a.getElementsByClassName?a.getElementsByClassName(b):document.getElementsByClassName(b)}
function wa(){for(var a=ta.width.s.value,b=ta.height.s.value,c,d,e=P.getElementsByTagName("*"),f=0;f<e.length;f++)c=parseInt(e.item(f).getAttribute("data-row")),d=parseInt(e.item(f).getAttribute("data-col")),e.item(f).setAttribute("transform","translate("+(2*d+1)*a+" "+(2*(7-c)+1)*b+") rotate(180)")}function Fa(){for(;P.firstElementChild;)X(P.firstElementChild).addEventListener("click",W),P.removeChild(P.firstElementChild);ua()}
function Ga(){0!==z.length&&(K(z[z.length-1]),1===ba[q]&&K(z[z.length-1]),Fa(),Da())}function Ha(){if(0!==z.length){for(;0<z.length;)K(z[z.length-1]);Fa();Da()}}function Da(){O("colorToPlay").setAttribute("class","token "+g[q])}function ya(a){O("prom_"+g[1-a]).style.visibility="hidden";O("prom_"+g[a]).style.visibility="visible";Z("prom",!0)}
function Ia(a){for(var b=O("prom_"+g[a]).getElementsByTagName("image"),c=0,d=1;4>c;c++,d++)b[c].setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","img/"+h[d]+"_"+g[a]+".svg"),b[c].setAttribute("data-piece",d),b[c].addEventListener("click",Ja)}function Z(a,b){O(a).style.display=b?"initial":"none";O(a).style.pointerEvents=b?"auto":"none"}function Ja(){sa=parseInt(this.getAttribute("data-piece"));Z("prom",!1);var a=za();a&&Aa(a)}
function Ka(a){Z("win",!1);Z("lose",!1);Ha();a.preventDefault()};na.load();oa.load();pa.load();for(var La,Ma=0;8>Ma;Ma++)for(var Na=0;8>Na;Na++)La=O(V(Ma,Na)),La.addEventListener("click",W);ua();O("pan-side1").addEventListener("click",Y);O("pan-side2").addEventListener("click",Y);O("toggleShowLegalMoves").setAttribute("class","token "+(B?"ON":"OFF"));O("toggleSound").setAttribute("class","token "+(A?"ON":"OFF"));O("rotateBoard").setAttribute("class","token "+(C?"ON":"OFF"));
O("toggleShowLegalMoves").addEventListener("click",function(){B=!B;O("toggleShowLegalMoves").setAttribute("class","token "+(B?"ON":"OFF"))});O("toggleSound").addEventListener("click",function(){A&&(na.pause(),oa.pause());A=!A;O("toggleSound").setAttribute("class","token "+(A?"ON":"OFF"))});
O("rotateBoard").addEventListener("click",function(){var a=O("svg");if(C=!C)a.setAttribute("class","rotate180"),wa(),window.addEventListener("resize",wa),O("rotateBoard").setAttribute("class","token ON");else{window.removeEventListener("resize",wa);a.setAttribute("class","");for(var a=P.getElementsByTagName("*"),b=0;b<a.length;b++)a.item(b).removeAttribute("transform");O("rotateBoard").setAttribute("class","token OFF")}});
O("logBoard").addEventListener("click",function(){console.log("Board ("+g[q]+" to play)");for(var a="",b=7;0<=b;b--){for(var c=0;8>c;c++)a=0===u[b][c]?a+"-":5===u[b][c].b?a+(1===u[b][c].color?"P":"p"):0===u[b][c].color?a+k[u[b][c].b].toLowerCase():a+k[u[b][c].b];a+="\n"}console.log(a)});O("logHistory").addEventListener("click",function(){console.log("Moves history ("+z.length+")");for(var a=0,b=1;a<z.length;a+=2,b++)console.log(b+": "+F(z[a])+(a+1<z.length?"\t"+F(z[a+1]):""))});
O("logLegalMoves").addEventListener("click",function(){var a=H(q);console.log("Legal moves for "+g[q]+" ("+a.length+")");a.forEach(function(a){console.log(F(a))})});O("logEval").addEventListener("click",function(){console.log("Evaluation for "+g[q]+": "+la())});O("logBestMove").addEventListener("click",function(){var a=new Date,b=ma(3,-1E9,1E9),c=new Date,d=[];b.j.forEach(function(a){d.push(F(a))});console.log("NegaMax(3): "+b.o+" ["+d.join(", ")+"]");console.log("I thought for "+(c-a)+"ms")});
O("redrawBoard").addEventListener("click",Fa);O("unplayLastMove").addEventListener("click",Ga);O("restartGame").addEventListener("click",Ha);Ia(0);Ia(1);O("cancelPromote").addEventListener("click",function(a){Y();Z("prom",!1);a.preventDefault()});O("playAgain").addEventListener("click",Ka);O("retry").addEventListener("click",Ka);O("unplayAfterLose").addEventListener("click",function(a){Z("lose",!1);Ga();a.preventDefault()});
